---
title: 'EDS 223: Discussion Week 9 - Workflows and Maps'
author: 'Name'
date: "2023-10-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

making your workflow more general by writing it as a function (this comes up in assignment 4)
pretty map making with ggplot - you could pick an example from the protected area stuff and walk them through how to make a nice map.

## Introduction

## Prerequsites 

```{r}
start = Sys.time()
library(tidyverse)
library(patchwork)
library(sf)
library(terra)
```

Load in the CPAD_2023a_SuperUnits.shp and the ghm.tif files. ghm.tif will take 5-8 minutes. Transform both to EPSG:4326.

```{r}
cpad_super <- st_read(here::here("discussion", "data", "CPAD_2023a_SuperUnits.shp")) %>%
  sf::st_transform("EPSG:4326") %>%
  janitor::clean_names() %>%
  mutate(ID = row_number())

ghm <- rast(here::here("discussion", "data", "gHM.tif")) %>%
  project("EPSG:4326")
```

While this loads - think about what you learned about raster/vector interactions last week. Discussion in your groups how you think you would combine these two datasets. 

## Exercises

1. Plot California protected areas by access level and by layer

```{r}
ggplot(data = cpad_super) +
  geom_sf(aes(color = access_typ, fill = access_typ)) +
  theme_bw()
```

```{r}
ggplot(data = cpad_super) +
  geom_sf(aes(color = layer, fill = layer)) +
  theme_bw()
```

2. Plot the Global human modification layer. *Hint: just use plot for ease*

```{r}
plot(ghm)
```

3. Crop and mask the raster to fit the area of the shapefile. Plot each step. *Hint: just use plot for ease*

```{r}
ghm_cropped = crop(ghm, cpad_super)

plot(ghm_cropped)

ghm_masked = mask(ghm_cropped, cpad_super)

plot(ghm_masked)
```

4. Extract the global human modification values at each California protected area.

```{r}
cpad_ghm_values <- terra::extract(x = ghm_masked, y = cpad_super)
```

5. Summarize the mean of human modification within each protected area

```{r}
cpad_ghm_summary <- cpad_ghm_values %>%
  group_by(ID) %>%
  summarize(gHM_mean = mean(gHM))
```

6.  Join this summary with the protected area database. Plot these values.

```{r}
cpad_ghm <- full_join(cpad_super, cpad_ghm_summary)
```

```{r}
ggplot() +
  geom_sf(data = cpad_ghm, aes(color = gHM_mean, fill = gHM_mean)) +
  theme_bw()
```

7. Join the entire human modification layer to the protected area database. Remove geometry and any missing values.

```{r}
cpad_values <- full_join(cpad_ghm_values, cpad_super) %>%
  select(-ID) %>%
  st_drop_geometry() %>% 
  drop_na()
```

8. Create two boxplots of human modification values, 1 across access_typ and 1 across layer. View these side by side.

```{r}
p7 <- ggplot(data = cpad_values) +
  geom_boxplot(aes(x = access_typ, y = gHM)) +
  theme_bw() +
  coord_flip() +
  labs(
    y = "Human Modification Index",
    x = "Access Level"
  )

p8 <- ggplot(data = cpad_values) +
  geom_boxplot(aes(x = layer, y = gHM), outlier.shape = NA) +
  theme_bw() +
  coord_flip() +
  labs(
    y = "Human Modification Index",
    x = "Agency Type"
  )

p7 + p8
```

```{r}
end = Sys.time()
start - end
```
